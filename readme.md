# task-12devs*
## ЗАДАНИЕ

### Legend  
Есть типичный разработчик, который занимается разработкой и поддержкой 10 веб-систем, разработанных на РНР5. Разработчику приходится в среднем несколько раз в неделю обновлять свои системы на stagiпg еnvironment путем обычного 'git pull' и возможно дополнительных ручных манипуляций. Дополнительные манипуляции могут включать:  
• ручное применение миграций к базам данных  
• ручной запуск каких-то скриптов.

### Staging еnvironment:
стек LЕМР — Linux, Nginx, MySQL, РНР.  
1 linux server который обслуживает 10 виртуальных хостов, например website1.com, website2.com, ... website10.com  


### Task descriptien
• Разработать систему для управления такого stagiпg еnvironment с использованием Docker.  
• Разработчику должно быть относительно просто обновлять все 10 веб-систем.  
• Разработку полноценной СI/СD системы не предлагать — это другое.  


## РЕШЕНИЕ (?)

### I. ход решения
1. изучил что же такое git (3 дня)**  
https://www.youtube.com/playlist?list=PLg5SS_4L6LYstwxTEOU05E0URTHnbtA0l

2. завел себе github (2 дня)  
https://github.com/eug-den, залил туда для пробы (да и для саморекламы, т.к. считаю, что неплохо написано) свою ранее разработанную программу на powershell

3. в AWS EC2 у меня есть машин (на amazon linux) с docker. На ней поднял дополнительно docker_compose и собрал LEMP (PHP,NGINX,MYSQL+phpMyadmin) (1 день)  
До этого был опыт сбора wordpress на чистых командах docker. поэтому получилось быстро.  
Использовал по сылке с https://hub.docker.com/_/php, где подбирал готовые образы для LEMP, информацию о его ращвертыванию с https://www.pascallandau.com/blog/php-php-fpm-and-nginx-on-docker-in-windows-10/  
*почему то не могу зайти с лок. компьютера (windows) в myphpadmin дальше картинки с регистрацией. Потратил много на это времени, пока не проверил с linux и телефона - все было норм. а с родного - фиг. С wordpress также было. Оставлю на потом.*

4. поднял на локальном сервере с proxmox виртуальную машину с debian, на котором продолжил. (1 день)  
*здесь docker-compose уже docker plugin: docker compose.*

5. изучил PHP и разработал 10 PHP приложений и установил их на 10 виртуальных серверов (1 целый день)  
https://www.tutorialrepublic.com/   - учебник PHP  
https://sebhastian.com/mysql-random-string/  заполнение rand данными.  
в автоматизации помог bash и sed

6. начал привязывавть git к получившейся конструкции  (1 день)  
   и писать этот файл. Сделал на машине в облаке AWS (из шага 3) git clone и проверил, что все работает.

7. 03.04.20223 продолжил описывать процесс работы всех частей в этом файле, параллельно упорядочивая структуру и дописывая отдельные скрипты и добавляя в них комментарии.
*markdown для меня новый формат. Использую plain text редактор и расширение GitLab Markdown Viewer для моего рабочего firefox*  

99. далее.   
    оптимизация docker-compose (нужны ли php и phpmyadmin, либо обойтись одним phpmyadmin)  
    передача параметров из docker-compose в PHP (?)  
    изменение алгоритма работы install.php, в случае если базы уже созданы -- obsolete?  
    упросить реализацию заполнения hosts, сделать комплект под linux.  
    разорбраться, что мешает работе phpmyadmin/wordpress на моейц машине  

### II. что в папках
db      - docker volume с базами MYSQL (содержимое в .gitignore, появится после установки)  
docker  - docker-compose ддя формировани LEMP с сопутствующими файлами  
html    - docker volume с содержимым виртуальных серверов  
hosts   - командные файлы (windows) для формаирования hosts-файла для доступа к виртуальным серверам  
nginx   - docker volume c конфигурациями виртуальных серверов NGINX  
php     - скрипты для создания и начального заполнения баз MYSQL соответствующих отдельным приложениям  

### III. как это работает (и что нужно, чтобы заработало)
Расчитано для работы на linux машине с docker и git. (заработает и на windows, если доработать пару скриптиков).  
Для установки docker на linux семейства debian в папке docker скрипт dockerinstall.sh (писался "для себя", поэтому надо его читать. Впрочем, говорят, все скрипты надо читать).  
Итак:  
получаем себе на машину комплект:  
*git clone git@github.com:eug-den/task-12devs.git*  
запускаем скрипт, который формирует базы, таблицы, а также осуществляет произвольное заполнение последних и стартует LEMP:  
*install.sh*  

Для формирования hosts-файла для доступа к виртуальным серверам (для проверки с windows-машины, у меня - так) запустить hosts\mkhostfile.cmd. 
Возможно, покажется слишком сложной эта реализация (три .cmd, отдельный, сложной структуры файл для хранения IP), просто это часть другой моей автоматизации управлением различными машинами (виртуальными)
Кстати, в файле IP используется # как коментарий на остальных строках IP, вызов getline берет номер строки, причем строки с коментарием не считаются.
Таким образом в файле с githab-a нужно заменить IP (192.168.0.101), располагающийся на 4 строке, т.к. в mkhostfile.cmd используется вызов getline 2.
Для linux такую автоматизацию (пока) не писал.

После этого, на машине с исправленнм hosts будут доступны виртуальные сайты website1.com, website2.com, ... website10.
Также доступен по адресу IP:8081 myphpadmin.
Для запуска скриптов скопировать их в ./html и открыть в браузере ip/имя.php
Например, если скопировать из ./php drob_db.php и открыть его, базы на всех сайтах будут уничтожены.
Затем, если скопировать из ./php install.php и открыть его, все восcтанвлится.  

В дальнейшем разработчик может обновлять сайты  (и остальное) путем git pull с githab. Можно было бы выделить все сайты в отдельные githab репозитории. 
Но при существующей сложности PHP разработок ;) это на мой взгляд не имеет смысла. И, по моему, не в этом смысл задачи.
При необходимости и усложнении проектов одна команда git pull заменяется на несколько, помещенных в командный файл.

* *task-12devs, говорят неправльное название, нужно было назвать task-twelvedevs*  
** *длинна дня варьируется от 20 мин до 6 часов... в среднем ~ 1 час*

