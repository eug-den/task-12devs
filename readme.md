# task-12devs*
## ЗАДАНИЕ

### Legend  
Есть типичный разработчик, который занимается разработкой и поддержкой 10 веб-систем, разработанных на РНР5. Разработчику приходится в среднем несколько раз в неделю обновлять свои системы на stagiпg еnvironment путем обычного 'git pull' и возможно дополнительных ручных манипуляций. Дополнительные манипуляции могут включать:  
• ручное применение миграций к базам данных  
• ручной запуск каких-то скриптов.

### Staging еnvironment:
стек LЕМР — Linux, Nginx, MySQL, РНР.  
1 linux server который обслуживает 10 виртуальных хостов, например website1.com, website2.com, ... website10.com  


### Task descriptien
• Разработать систему для управления такого stagiпg еnvironment с использованием Docker.  
• Разработчику должно быть относительно просто обновлять все 10 веб-систем.  
• Разработку полноценной СI/СD системы не предлагать — это другое.  


## РЕШЕНИЕ (?)

# I. Что сделано
Официальные docker images nginx, mysql, php, phpmyadmin объединены в LEMP стек. 
Образ PHP модернезирован для поддержки mysqli, т.к. везде используются последние версии.  
Volume:  
конфигурация nginx - /etc/nginx/conf.d -> ./nginx/conf.d  
содержимое сайтов nginx/php - /var/www/html -> ./html   
базы mysql - /var/lib/mysql -> ./db  
Порты:  
80	- nginx  
9000	- php  
3306	- mysql  
8081    - phpmyadmin  

Сформированы конфигурации виртуальных сайов nginx: /etc/nginx/conf.d/website[1-10].com.conf
(Автоматизировано с использованием скрипта ./nginx/doconf.sh)  

Написаны скрипты для автоматического формирования hosts файлов (под windows) для различных (меняющихся IP): ./hosts  

Сформированы содержимое виртуальных сайов nginx: /var/www/html/website[1-10]/index.php 
(Автоматизировано с использованием скрипта ./nginx/doconf.sh)  
Разработан скрипт для создания тестовых баз и таблиц, и заполнения последних данными для каждого сайта: ./php/install.php  
А также скрипт для их удаления: ./php/drob_db.php  

Скрипт для разворачивания системы после git clone: ./install.sh

Написан этот файл.  

Структура папок:  
docker  - docker-compose ддя формировани LEMP с сопутствующими файлами  
html    - docker volume с содержимым виртуальных серверов  
hosts   - командные файлы (windows) для формаирования hosts-файла для доступа к виртуальным серверам  
nginx   - docker volume c конфигурациями виртуальных серверов NGINX  
php     - скрипты для создания и начального заполнения баз MYSQL соответствующих отдельным приложениям  
db      - docker volume с базами MYSQL (содержимое в .gitignore, появится после установки)  

### II. установка
**На staging environment:**  
Требуется установленный docker и git.  
Для установки docker на linux семейства debian в папке docker скрипт dockerinstall.sh (писался "для себя").  
Итак:  
- получаем себе на машину комплект с репозитория guthab:  
`git clone https://github.com/eug-den/task-12devs.git`  

- запускаем скрипт, который формирует базы, таблицы, а также осуществляет произвольное заполнение последних и стартует LEMP:  
`./install.sh`  
Данный скрипт может потребовать корректировки:  
- в зависимости от наличия docker-compose или plugin-а docker compose (по умолчанию "docker compose")  
-  задержки перед запуском команды формирования баз данных, колторая требуется для полной загрузки LEMP.  
Для этого изменить переменную SLEEP_TIME (30). У меня на VM на локальном proxmox достаточно было 10, а на AWS EC2 этого было мало  

**На клиентской машине**  
Необходимо сформировать hosts файл.  
Для формирования hosts-файла для доступа к виртуальным серверам (для проверки с windows-машины, у меня - так) запустить hosts\mkhostfile.cmd, 
предварительно на 4 строке файла ip указать IP машины на которой организован staging environment.   
*Возможно, покажется слишком сложной эта реализация (три .cmd, отдельный, сложной структуры файл для хранения IP), просто это часть другой моей автоматизации управлением различными машинами (виртуальными)
В файле IP используется # как коментарий на остальных строках IP, вызов getline берет номер строки, причем строки с коментарием не считаются.
Короче: для формирования файла C:\Windows\System32\drivers\etc\hosts в файле hosts/ip нужно заменить 4 строку с на которй указан IP 192.168.0.101 на IP машины, где (будет) развернут LEMP.*  
Для linux такую автоматизацию (пока) не писал.  
После этого, на машине с исправленным hosts будут доступны виртуальные сайты website1.com, website2.com, ... website10.

### III. Использование

Доступны:  
- виртуальные сайты website1.com, website2.com, ... website10.com  
- myphpadmin по адресу website0.com:8081  
- запуск скриптов php с website0.com. Для этого их нужно скопировать в ./html и открыть в браузере website0.com/имя.php  
Например:  
если скопировать `cp ./php/drob_db.php ./html/drob_db.php` и затем открыть его `website0.com/drob_db.php`: базы на всех сайтах будут уничтожены.  
если после этого скопировать `cp ./php/install.php .html/install.php` и открыть его `website0.com/install.php`: базы восcтановится.  

В дальнейшем разработчик может обновлять сайты  (и остальное) путем `git pull` с githab. Можно было бы выделить все сайты в отдельные githab репозитории. 
Но, кажется, смысл задачине в этом. Впрочем, при необходимости (усложнении проектов) одна команда git pull заменяется на несколько, помещенных в командный файл.  

### IV. ход решения (можно не читать)
1. изучил, что же такое git (3 дня):**  
https://www.youtube.com/playlist?list=PLg5SS_4L6LYstwxTEOU05E0URTHnbtA0l

2. завел себе github: (2 дня)  
https://github.com/eug-den, залил туда для пробы (да и для саморекламы, т.к. считаю, что неплохо написано) свою ранее разработанную программу на powershell  
*так вот зачем нужно корректировать локальный .ssh/config*

3. в AWS EC2 у меня есть машинка (на amazon linux) с docker. На ней поднял дополнительно docker-compose и собрал LEMP (PHP,NGINX,MYSQL+phpMyadmin) (1 день)  
До этого был опыт сбора wordpress на чистых командах docker, поэтому получилось быстро.  
Использовал по сылке с https://hub.docker.com/_/php, где подбирал готовые образы для LEMP, информацию о его развертыванию с https://www.pascallandau.com/blog/php-php-fpm-and-nginx-on-docker-in-windows-10/  
*почему то не могу зайти с лок. компьютера (windows) в myphpadmin дальше картинки с регистрацией. Потратил много на это времени, пока не проверил с linux и телефона - все было норм. а с родного - фиг. С wordpress также было. Оставлю на потом.*

4. поднял на локальном сервере с proxmox виртуальную машину с debian, на котором продолжил. (1 день)  
*здесь docker-compose уже docker plugin: docker compose.*

5. изучил PHP и разработал 10 PHP приложений и установил их на 10 виртуальных серверов (1 целый день)  
https://www.tutorialrepublic.com/   - учебник PHP  
https://sebhastian.com/mysql-random-string/  заполнение rand данными.  
в автоматизации помог bash и sed

6. начал привязывавть git к получившейся конструкции  (1 день)  
   и писать этот файл. Сделал на машине в облаке AWS (из шага 3) git clone и проверил, что все работает.

7. 03.04.20223 продолжил описывать процесс работы всех частей в этом файле, параллельно упорядочивая структуру и дописывая отдельные скрипты и добавляя в них комментарии.  
проверил и отладил установку на чистую машину (debian и amazon linux).
*markdown для меня новый формат. Использую plain text редактор и расширение GitLab Markdown Viewer для моего рабочего firefox*  
вот этот пункт оказался самым времязатратным.

99. далее.   
    оптимизация docker-compose (нужны ли php и phpmyadmin, либо обойтись одним phpmyadmin)  
    передача параметров из docker-compose в PHP (?)  
    изменение алгоритма работы install.php, в случае если базы уже созданы (obsolete?)  
    упросить реализацию заполнения hosts, сделать под linux  
    разорбраться, что мешает работе phpmyadmin/wordpress на моейц машине  


* *task-12devs, говорят неправльное название, нужно было назвать task-twelvedevs*  
** *длинна дня варьируется от 20 мин до 6 часов... в среднем ~ 1 час*

